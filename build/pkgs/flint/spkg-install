#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

./test_gcc_version.pl
if [ $? -ne 0 ]; then
   echo "GCC version less than 3.4.0"
   echo "Flint will not be able to compile successfully"
   exit 1
fi

if [ "`uname`" = "Linux" -a "`uname -m`" = "x86_64" ]; then
   FLINT_TUNE="-mtune=opteron -march=opteron -fPIC -funroll-loops "
elif [ "`uname`" = "Darwin" -a "`uname -m`" = "Power Macintosh" ]; then
   FLINT_TUNE=" -fPIC -funroll-loops "
elif [ "`uname -m`" = "ia64" ]; then
   # -funroll-loops crashes the build on itanium under GCC-4.2.1, as reported by
   # Kate Minola.
   FLINT_TUNE=" -fPIC "
else
   FLINT_TUNE=" -fPIC -funroll-loops  "
fi

export FLINT_TUNE

FLINT_GMP_INCLUDE_DIR="$SAGE_LOCAL"/include/
FLINT_GMP_LIB_DIR="$SAGE_LOCAL"/lib/

FLINT_NTL_INCLUDE_DIR="$SAGE_LOCAL"/include
FLINT_NTL_LIB_DIR="$SAGE_LOCAL"/lib/

# What is QD??
FLINT_QD_LIB_DIR="$SAGE_LOCAL"/include
FLINT_QD_INCLUDE_DIR="$SAGE_LOCAL"/include

export FLINT_GMP_INCLUDE_DIR
export FLINT_GMP_LIB_DIR
export FLINT_QD_INCLUDE_DIR
export FLINT_QD_LIB_DIR
export FLINT_NTL_INCLUDE_DIR
export FLINT_NTL_LIB_DIR

###
FLINT_LINK_OPTIONS=""
export FLINT_LINK_OPTIONS

cp patches/DIRNAME src/
cp patches/makefile src/
cd src

# UNIX
if [ $UNAME != "Darwin" ]; then
    $MAKE libflint.so
    if [ $? -ne 0 ]; then
        echo "Error building flint shared library."
        exit 1
    fi
    $RM "$SAGE_LOCAL/lib/libflint*.so"
    $CP libflint-1.06.so "$SAGE_LOCAL/lib/"
    CUR=`pwd`
    cd $SAGE_LOCAL/lib; $LN -s libflint-1.06.so libflint.so
    cd $CUR
fi

# OS X
if [ $UNAME = "Darwin" ]; then
    $MAKE libflint.dylib
    if [ ! -f libflint.dylib ]; then
        echo "Failed to build FLINT dylib."
        exit 1
    fi
    $CP libflint.dylib "$SAGE_LOCAL/lib/"
fi


# Copy the header files

rm -rf "$SAGE_LOCAL"/include/FLINT
mkdir "$SAGE_LOCAL"/include/FLINT

if [ $? -ne 0 ]; then
    echo "Error building FLINT"
    exit 1
fi

$CP *.h "$SAGE_LOCAL"/include/FLINT/

if [ $? -ne 0 ]; then
    echo "Error building FLINT"
    exit 1
fi

#uncomment the line below to avoid running the test suite.
#this should be done in all final releases
exit 0
#cd ..; ./spkg-check

