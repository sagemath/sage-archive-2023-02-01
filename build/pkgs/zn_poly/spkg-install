#!/usr/bin/env bash

################################################################
#
#  zn_poly sage install script
#
################################################################

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi


if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel"
   CFLAGS="-O3 -g -m64 -fPIC -L."; export CFLAGS
   LDFLAGS="-m64 "; export LDFLAGS
   cp patches/makemakefile.py src/makemakefile.py
else
   CFLAGS="-fPIC -O3 -L."; export CFLAGS
   LDFLAGS=""; export LDFLAGS
fi

cd src

./configure --gmp-prefix="$SAGE_LOCAL" --ntl-prefix="$SAGE_LOCAL" \
            --prefix="$SAGE_LOCAL" --cflags="$CFLAGS" --ldflags="$LDFLAGS"

# optionally run tuning program, only takes 1 minute or so
make tune
tune/tune > src/tuning.c


# run test suite (quick version)
make check


make


# UNIX
if [ $UNAME != "Darwin" ]; then
    $MAKE libzn_poly.so
    if [ $? -ne 0 ]; then
        echo "Error building zn_poly shared library."
        exit 1
    fi
    $CP libzn_poly-0.9.so "$SAGE_LOCAL/lib/"
    (cd $SAGE_LOCAL/lib/ && ln -sf libzn_poly-0.9.so libzn_poly.so)
fi


# OS X
if [ $UNAME = "Darwin" ]; then
    if [ "$SAGE64" = "yes" ]; then
      $MAKE libzn_poly.dylib64
    else
      $MAKE libzn_poly.dylib
    fi
    if [ ! -f libzn_poly.dylib ]; then
        echo "Failed to build zn_poly dylib."
        exit 1
    fi
    $CP libzn_poly.dylib "$SAGE_LOCAL/lib/"
fi

# copy header files

mkdir -p $SAGE_LOCAL/include/zn_poly
$CP include/zn_poly.h $SAGE_LOCAL/include/zn_poly
$CP include/wide_arith.h $SAGE_LOCAL/include/zn_poly


if [ $? -ne 0 ]; then
    echo "Error building zn_poly"
    exit 1
fi
