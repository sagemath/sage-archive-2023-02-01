#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel"
   CFLAGS="-O2 -g -m64 "; export CFLAGS
   LDFLAGS="-m64 "; export LDFLAGS
fi

# Use patched versions.  See SPKG.txt for why and what.
$CP patches/setupext.py src
$CP patches/cbook.py src/lib/matplotlib/cbook.py
$CP patches/patches.py src/lib/matplotlib/patches.py

if [ `uname` = "SunOS" ]; then
    echo "Copy patched version of pprdrv_tt2.cpp for Solaris 10 that builds with gcc 4.3.2"
    $CP patches/pprdrv_tt2.cpp src/ttconv/pprdrv_tt2.cpp
fi

echo "Work around a problem building tkgui on some Linux/Solaris machines."
echo "This is a 1-line fix that just turns off checking and building for that GUI frontend."
$CP patches/setup.py src/setup.py

cd src

# Now build
python setup.py build

if [ $? -ne 0 ]; then
   echo "Error building matplotlib package."
   exit 1
fi

rm -rf "$SAGE_LOCAL"/lib/python/site-packages/matplotlib

# Finally install
python setup.py install

