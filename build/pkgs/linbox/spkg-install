#!/bin/sh

CUR=`pwd`

echo "Copying commentator patch"
cp patches/commentator.C linbox/linbox/util/

if [ $? -ne 0 ]; then
    echo "Error copying commentator OSX 10.4 fix"
    exit 1
fi

cd linbox/

CFLAGS="$CFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"-L\"$SAGE_LOCAL/lib\""
CXXFLAGS="$CXXFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"  -L\"$SAGE_LOCAL/lib\""
CPPFLAGS="$CPPFLAGS -g -I\"$SAGE_LOCAL/include/linbox\" -I\"$SAGE_LOCAL\"/include"

export CFLAGS
export CXXFLAGS
export CPPFLAGS

if [ "$LINBOX_BLAS" != "" ]; then

    echo "Using environment variable LINBOX_BLAS "$LINBOX_BLAS""

elif [ $UNAME = "Darwin" -a -f "/usr/lib/libcblas.dylib" ]; then

    LINBOX_BLAS=/usr/lib/libcblas.dylib

elif [ $UNAME = "Linux" -a -f "${SAGE_LOCAL}/lib/libcblas.so" ]; then

    echo "Linux cblas"

    LINBOX_BLAS="-lcblas -latlas"

elif [ $UNAME = "CYGWIN" -a -f "${SAGE_LOCAL}/lib/libcblas.a" ]; then

    echo "Linux cblas"

    LINBOX_BLAS="-lcblas -latlas"

elif [ $UNAME = "SunOS" -a -f "${SAGE_LOCAL}/lib/libcblas.so" ]; then

    echo "Solaris cblas"

    LINBOX_BLAS="-lcblas -latlas"

else
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "using frickin' slow GSL C-blas"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"

    if [ $UNAME = "Darwin" ]; then
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.dylib
    else
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.so
    fi

fi

echo "*************************************************"
echo " Using LINBOX_BLAS=$LINBOX_BLAS"
echo "*************************************************"

./configure --prefix="$SAGE_LOCAL" --with-givaro="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL" --with-ntl="$SAGE_LOCAL" --enable-optimization --with-blas="$LINBOX_BLAS"

if [ $? -ne 0 ]; then
    echo "Error configuring linbox"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error building linbox"
fi

make install
if [ $? -ne 0 ]; then
    echo "Error installing linbox"
    exit 1
fi

#
# Build the C Wrapper
#

cd "$CUR"/linbox_wrap

./configure --prefix="$SAGE_LOCAL" --with-blas="$LINBOX_BLAS"

if [ $? -ne 0 ]; then
    echo "Error configuring linboxwrap"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error building linboxwrap"
fi

make install
if [ $? -ne 0 ]; then
    echo "Error installing linboxwrap"
    exit 1
fi

