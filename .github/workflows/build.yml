name: Build & Test

on: [push, pull_request]

jobs:
  windows:
    runs-on: windows-latest
    name: Windows (using WSL)
    # Following https://trac.sagemath.org/ticket/25206#comment:63
    steps:
    - name: Configure git
      run: git config --global core.symlinks true
    - uses: actions/checkout@v2
    - name: Install Ubuntu 20.04 (in WSL)
      run: |
        (New-Object System.Net.WebClient).DownloadFile("https://aka.ms/wslubuntu2004", "Ubuntu.appx")
        Expand-Archive Ubuntu.appx
        Ubuntu\ubuntu2004.exe install --root
    - name: Install dependencies
      run: |
        Function ExtractPackages
        {
           param($path)
           @(Get-Content $path | Where-Object { !$_.StartsWith("#") })
        }

        & wsl sudo apt-get update -y 
        & wsl sudo apt-get install -y @(ExtractPackages '.\build\pkgs\debian.txt')
        & wsl sudo apt-get install -y @(ExtractPackages '.\build\pkgs\debian-bootstrap.txt')
        & wsl sudo apt-get install -y tox
    - name: Build
      run: wsl MAKE="make -j2" tox -e local -- SAGE_NUM_THREADS=4 build
      # If make is invoked in parellel (i.e. with -jN where N > 1), then we run into errors for some reason
    - name: Test
      run: wsl tox -e local -- SAGE_NUM_THREADS=4 ptest
    - name: Prepare logs artifact
      run: mkdir -p "artifacts/logs"; cp -r .tox/*/log "artifacts/logs"
      shell: bash
      if: always()
    - uses: actions/upload-artifact@v1
      with:
        path: artifacts
        name: logs
      if: always()
    - name: Print out logs for immediate inspection
      # and markup the output with GitHub Actions logging commands
      run: .github/workflows/scan-logs.sh "artifacts/logs"
      shell: bash
      if: always()
