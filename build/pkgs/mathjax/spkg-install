#!/bin/sh


# Check required environment variable
    if [ -z "$SAGE_SHARE" ]; then
        echo >&2 "SAGE_SHARE undefined ... exiting"
        echo >&2 "Maybe run 'sage --sh'?"
        exit 1
    fi


# Apply all patches
    for patch in patches/*.patch; do
        [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
        echo "Applying $patch"
        patch -p1 <"$patch"
        if [ $? -ne 0 ]; then
            echo >&2 "Error applying '$patch'"
            exit 1
        fi
    done


# Strip mathjax according to
# https://github.com/mathjax/MathJax-docs/wiki/Guide%3A-reducing-size-of-a-mathjax-installation

    # Trimming I -- removing files unnecessary for deployment
        FILEDIRS_TO_REMOVE='docs/ test/ unpacked/ .gitignore README-branch.txt README.md bower.json'
        for filedir in ${FILEDIRS_TO_REMOVE} ; do
            rm -rf "src/${filedir}"
        done

    # Trimming II -- not strictly necessary (requires the patch nopng_config.patch)
        rm -rf 'src/fonts/HTML-CSS/TeX/png/'

    # Trimming III -- fonts
        FONTS_TO_REMOVE='Asana-Math Gyre-Pagella Gyre-Termes Latin-Modern Neo-Euler'
        for font in ${FONTS_TO_REMOVE} ; do
            find . -type d -name "${font}" -prune -exec rm -rf {} \;
        done

        FONT_FORMATS_TO_REMOVE='eot otf svg'
        for fontformat in ${FONT_FORMATS_TO_REMOVE} ; do
            find . -type d -name "${fontformat}" -prune -exec rm -rf {} \;
        done

    # Trimming IV -- reducing input and output options
        OUTPUT_OPTIONS_TO_REMOVE='NativeMML SVG'
        for output in ${OUTPUT_OPTIONS_TO_REMOVE} ; do
            rm -rf "src/jax/output/${output}"
        done


# Move mathjax to its final destination.
    TARGET="${SAGE_SHARE}/mathjax"
    rm -rf "${TARGET}"
    cp -r 'src' "${TARGET}"

