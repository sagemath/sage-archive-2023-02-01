#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ] ; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi


# Only build iconv on Solaris and Cygwin
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] ; then
  echo "iconv will not be installed, as we only need to build it on"
  echo "Solaris and Cygwin - see:"
  echo "http://trac.sagemath.org/sage_trac/ticket/8567"
  exit 0
fi

echo "Installing iconv as the operating system is Solaris or Cygwin"


echo "Removing old iconv files if they exist"
# If iconv is updated, please double-check these are still necessary
# and that there are no extra files added.

rm -f $SAGE_LOCAL/bin/iconv  $SAGE_LOCAL/lib/charset.alias
rm -f $SAGE_LOCAL/lib/*libiconv*  $SAGE_LOCAL/lib/libcharset*
rm -f $SAGE_LOCAL/include/iconv.h  $SAGE_LOCAL/include/libcharset.h
rm -f $SAGE_LOCAL/include/localcharset.h
rm -rf  $SAGE_LOCAL/share/doc/libiconv
rm -f $SAGE_LOCAL/share/man/man1/iconv* $SAGE_LOCAL/share/man/man3/iconv*


# Let an environment variable CFLAG64 specify the option to generate 64-bit
# code. If this is not set, default to -m64.
if [ -z "$CFLAG64" ] ; then
   CFLAG64=-m64
fi

# Add option for a 64-bit build if needed.
if [ "x$SAGE64" = xyes ] ; then
  CFLAGS="$CFLAG64"
  export CFLAGS
fi

cd src
./configure --prefix=$SAGE_LOCAL
if [ $? -ne 0 ]; then
    echo "Error configuring iconv"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error making iconv"
    exit 1
fi

make install

if [ $? -ne 0 ]; then
    echo "Error installing iconv"
    exit 1
fi

