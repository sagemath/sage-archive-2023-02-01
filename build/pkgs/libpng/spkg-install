#!/bin/sh

cd src

# Need to detect zlib
if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
    CFLAGS="-m64 $CFLAGS -fPIC -g -I$SAGE_LOCAL/include"
    LDFLAGS="-m64"; export LDFLAGS
else
    CFLAGS="$CFLAGS -fPIC -g -I$SAGE_LOCAL/include"
fi
export CFLAGS


./configure --prefix="$SAGE_LOCAL" --enable-shared=yes
if [ $? -ne 0 ]; then
    echo "Error configuring libpng"
    exit 1
fi

make

if [ $? -ne 0 ]; then
    echo "Error building libpng"
    exit 1
fi

make install

if [ $? -ne 0 ]; then
    echo "Error installing libpng"
    exit 1
fi


if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "Keeping 64 bit OSX libpng.dylib around"
else
    # There is a weird problem on Darwin where most programs
    # will crash if they see the libpng built as part of this
    # package instead of the system-wide apple libpng.  So
    # we delete it.
    # NOTE -- we *only* delete the dylib's.  Apps that need libpng can still link it in statically.
    rm -f "$SAGE_LOCAL"/lib/libpng*dylib
    rm -f "$SAGE_LOCAL"/lib/libpng*.la
fi

