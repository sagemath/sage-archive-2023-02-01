#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

CUR=`pwd`

echo "Copying commentator patch"
cp patches/commentator.C linbox/linbox/util/

if [ $? -ne 0 ]; then
    echo "Error copying commentator OSX 10.4 fix"
    exit 1
fi

echo "Copying ffpack.h patch for charpoly mpd p issue (#3671)"
cp patches/ffpack.h linbox/linbox/ffpack/
if [ $? -ne 0 ]; then
    echo "Error copying ffpack.h patch for charpoly mod p issue"
    exit 1
fi

cd linbox/

CFLAGS="$CFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"-L\"$SAGE_LOCAL/lib\""
CXXFLAGS="$CXXFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"  -L\"$SAGE_LOCAL/lib\""
CPPFLAGS="$CPPFLAGS -g -I\"$SAGE_LOCAL/include/linbox\" -I\"$SAGE_LOCAL\"/include"

export CFLAGS
export CXXFLAGS
export CPPFLAGS

if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel"
   CFLAGS="-m64 $CFLAGS "; export CFLAGS
   CXXFLAGS="-m64 $CXXFLAGS "; export CXXFLAGS
   CPPFLAGS="-m64 $CPPFLAGS "; export CPPFLAGS
   LDFLAGS="-m64"; export LDFLAGS
fi


if [ "$LINBOX_BLAS" != "" ]; then

    echo "Using environment variable LINBOX_BLAS "$LINBOX_BLAS""

elif [ $UNAME = "Darwin" -a -f "/usr/lib/libcblas.dylib" ]; then

    LINBOX_BLAS=/usr/lib/libcblas.dylib

elif [ $UNAME = "Linux" -a -f "${SAGE_LOCAL}/lib/libcblas.so" ]; then

    echo "Linux cblas"

    LINBOX_BLAS="-lcblas -latlas"

elif [ $UNAME = "CYGWIN" -a -f "${SAGE_LOCAL}/lib/libcblas.a" ]; then

    echo "Linux cblas"

    LINBOX_BLAS="-lcblas -latlas"

elif [ $UNAME = "SunOS" -a -f "${SAGE_LOCAL}/lib/libcblas.so" ]; then

    echo "Solaris cblas"

    LINBOX_BLAS="-lcblas -latlas"

else
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "using frickin' slow GSL C-blas"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"

    if [ $UNAME = "Darwin" ]; then
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.dylib
    else
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.so
    fi

fi

echo "*************************************************"
echo " Using LINBOX_BLAS=$LINBOX_BLAS"
echo "*************************************************"

./configure --prefix="$SAGE_LOCAL" --with-givaro="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL" --with-ntl="$SAGE_LOCAL"  --with-blas="$LINBOX_BLAS" --enable-sage --enable-optimization --disable-static

if [ $? -ne 0 ]; then
    echo "Error configuring linbox"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error building linbox"
fi

make install
if [ $? -ne 0 ]; then
    echo "Error installing linbox"
    exit 1
fi


