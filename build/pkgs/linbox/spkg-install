#!/bin/sh

CUR=`pwd`


# !!!  a temporary patches that so far I'm only sure we
# need on OS X Powerpc.  That said, the algorithm used
# for det without this patch seems very flaky.
$CP patches/det.h linbox/linbox/solutions/


$CP patches/configure linbox/
$CP patches/install-sh linbox/
$CP patches/mkinstalldirs linbox/
$CP patches/fflas_bounds.inl linbox/linbox/fflas/

cd linbox/

CFLAGS="$CFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"-L\"$SAGE_LOCAL/lib\""
CXXFLAGS="$CXXFLAGS -g -fPIC -I\"$SAGE_LOCAL/include\" -I\"$SAGE_LOCAL/include/linbox\"  -L\"$SAGE_LOCAL/lib\""
CPPFLAGS="$CPPFLAGS -g -I\"$SAGE_LOCAL/include/linbox\" -I\"$SAGE_LOCAL\"/include"

export CFLAGS
export CXXFLAGS
export CPPFLAGS

if [ "$LINBOX_BLAS" != "" ]; then

    echo "Using environment variable LINBOX_BLAS "$LINBOX_BLAS""

elif [ $UNAME = "Darwin" -a -f "/usr/lib/libcblas.dylib" ]; then

    LINBOX_BLAS=/usr/lib/libcblas.dylib

elif [ $UNAME = "Linux" -a -f "/usr/lib/libcblas.so" ]; then

    echo "Linux cblas"

    LINBOX_BLAS=/usr/lib/libcblas.so

elif [ $UNAME = "Linux" -a -f "/usr/lib/libcblas.so.3" ]; then

    echo "Linux cblas"

    LINBOX_BLAS=/usr/lib/libcblas.so.3

elif [ $UNAME = "SunOS" -a -f "/usr/lib/libcblas.so" ]; then

    echo "Solaris cblas"

    LINBOX_BLAS=/usr/lib/libcblas.so

else
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "using frickin' slow GSL C-blas"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"
    echo "WARNING WARNING"

    if [ $UNAME = "Darwin" ]; then
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.dylib
    else
        LINBOX_BLAS="$SAGE_LOCAL"/lib/libgslcblas.so
    fi

fi

if [ $UNAME = "SunOS" ]; then
   OPT="--enable-optimization=false"
   echo "Building on SunOS"
else
   OPT="--enable-optimization"
fi

./configure --prefix="$SAGE_LOCAL" --with-givaro="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL" --with-ntl="$SAGE_LOCAL" $OPS --with-blas="$LINBOX_BLAS"

if [ $? -ne 0 ]; then
    echo "Error configuring linbox"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error building linbox"
fi

make install
if [ $? -ne 0 ]; then
    echo "Error installing linbox"
    exit 1
fi

cd "$CUR"/patches
cp -r gmp++/* "$SAGE_LOCAL"/include/gmp++/
if [ $? -ne 0 ]; then
    echo "Error overwriting linbox's gmp++"
    exit 1
fi


# For some stupid reason gmp-integers.h was removed.
cp "$CUR"/patches/gmp-integers.h "$SAGE_LOCAL"/include/linbox/field/

#
# Build the C Wrapper
#

cd "$CUR"/linbox_wrap

./configure --prefix="$SAGE_LOCAL" --with-blas="$LINBOX_BLAS"

if [ $? -ne 0 ]; then
    echo "Error configuring linboxwrap"
    exit 1
fi

make
if [ $? -ne 0 ]; then
    echo "Error building linboxwrap"
fi

make install
if [ $? -ne 0 ]; then
    echo "Error installing linboxwrap"
    exit 1
fi

