#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cp patches/lanczos.h  src/

cd src

if [ `uname -m` = "x86_64" ]; then
    $CP makefile.opteron makefile
else
    if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
        $CP makefile.osx64 makefile
    else
        $CP makefile.sage makefile
    fi
fi

$MAKE

if [ $? -ne 0 ]; then
    echo "Error building William Hart's Quadratic Sieve"
    if [ `uname -m` = "x86_64" ]; then
       $CP makefile.sage makefile
       $MAKE
    else
       exit 1
    fi
fi

if [ $? -ne 0 ]; then
    echo "Error building William Hart's Quadratic Sieve"
    exit 1
fi

if [ ! -f QuadraticSieve ]; then
    echo "Error building William Hart's Quadratic Sieve -- no file QuadraticSieve was produced."
    exit 1
fi

$CP QuadraticSieve "$SAGE_LOCAL"/bin/

exit 0
