# First install tox:
#
#   ./sage -i tox
#
# All tests require an installation of the non-Python components of the Sage distribution
# in SAGE_LOCAL.
#
# See envlist below for different environments.
#
# To build and test in the tox environment using the concrete Python dependencies specified
# by requirements.txt, using the wheels built and stored by the Sage distribution:
# (Using 'sage -sh' ensures that we use the same Python as the one that we built the wheels
#  for. This can also be done ensured manually by using the tox environment py38-sagewheels etc.)
#
# Afterwards, to test interactively:
#
#   build/pkgs/sagelib/src/.tox/ENVIRONMENT/bin/python
#   build/pkgs/sagelib/src/.tox/ENVIRONMENT/bin/sage
#
[tox]
envlist =
    #
    # SUPPORTED ENVIRONMENTS:
    #
    # Build dependencies according to requirements.txt (all versions fixed).
    # Use ONLY the wheels built and stored by the Sage distribution (no PyPI):
    #
    #   ./sage -sh -c '(cd build/pkgs/sagelib/src && tox -v -v -v -e python-sagewheels-nopypi)'
    #
    python-sagewheels-nopypi,
    #
    # Build and test without using the concrete dependencies specified by requirements.txt,
    # using the dependencies declared in pyproject.toml and setup.cfg (install-requires) only:
    # Still use ONLY the wheels built and stored by the Sage distribution (no PyPI).
    #
    #   ./sage -sh -c '(cd build/pkgs/sagelib/src && tox -v -v -v -e python-sagewheels-nopypi-norequirements)'
    #
    python-sagewheels-nopypi-norequirements,
    #
    # EXPERIMENTAL ENVIRONMENTS:
    #
    # Build dependencies according to requirements.txt (all versions fixed).
    # Use the wheels built and stored by the Sage distribution,
    # and additionally allow packages from PyPI.
    # Because all versions are fixed, we "should" end up using the prebuilt wheels.
    #
    #   ./sage -sh -c '(cd build/pkgs/sagelib/src && tox -v -v -v -e python-sagewheels)'
    #
    python-sagewheels,
    #
    # Likewise, but using pipenv using Pipfile-dist (= SAGE_ROOT/Pipfile).
    # This also fixes the concrete dependencies (at least for some packages).
    #
    python-sagewheels-pipenv-dist,
    #
    # Build using the dependencies declared in pyproject.toml and setup.cfg (install-requires) only.
    # Use the wheels built and stored by the Sage distribution,
    # and additionally allow packages from PyPI.
    #
    # Because the version ranges will allow for packages to come in from PyPI (in source or wheel form),
    # this is likely to fail because we do not have control over the configuration of these packages.
    #
    python-sagewheels-norequirements,
    #
    # Likewise, but using pipenv
    #
    python-sagewheels-pipenv

[testenv]
deps =
    pipenv:                  pipenv
    !pipenv-!norequirements: -rrequirements.txt
    ## Needed for fpylll
    norequirements:          Cython
    norequirements:          cysignals

passenv =
    # Variables set by .homebrew-build-env
                             CPATH
                             LIBRARY_PATH
                             PKG_CONFIG_PATH
    # SAGE_LOCAL only for finding the wheels
    sagewheels:              SAGE_LOCAL
    # Location of the wheels (needs to include a PEP 503 compliant
    # Simple Repository index, i.e., a subdirectory "simple")
    sagewheels:              SAGE_SPKG_WHEELS

setenv =
    # Sage scripts such as sage-runtests like to use $HOME/.sage
    HOME={envdir}
    # We supply pip options by environment variables so that they
    # apply both to the installation of the dependencies and of the package
    sagewheels:              PIP_FIND_LINKS=file://{env:SAGE_SPKG_WHEELS:{env:SAGE_LOCAL:{toxinidir}/../../../../local}/var/lib/sage/wheels}
    nopypi:                  PIP_NO_INDEX=true
    # Do not write or use Pipfile.lock -- we cannot seem to set its location,
    # so we cannot isolate it in the tox environment.
    pipenv:                  PIPENV_SKIP_LOCK=true

whitelist_externals =
    bash

skip_install =
    pipenv:                  True
    !pipenv:                 False

commands_pre =
    # Use Pipenv to install according to Pipfile into the virtual environment created by tox.
    # https://pipenv-searchable.readthedocs.io/advanced.html#tox-automation-project
    pipenv-!dist:            pipenv install -v -v -v
    # Same, but use $SAGE_ROOT/Pipfile
    pipenv-dist:             bash -c '(cd ../../../.. && pipenv install -v -v -v)'

commands =
    # Beware of the treacherous non-src layout. "./sage/" shadows the installed sage package.
    python -c 'import sys; "" in sys.path and sys.path.remove(""); import sage.all; print(sage.all.__file__)'

    # We check that the "sage" script invokes the correct Python.
    sage -c 'import sys; print("sys.path =", sys.path); import sage.all; print(sage.all.__file__)'

    sage -t -p --all
