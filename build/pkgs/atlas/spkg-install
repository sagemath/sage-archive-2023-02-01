#!/bin/sh

###########################################
## ATLAS
###########################################

FCOMPILER="$SAGE_LOCAL"/bin/sage_fortran
bitwidth=`python ./bitwidth.py`
echo "Platform detected to be $bitwidth bits"

python system_atlas.py
output=$?

#system_atlas script exits with status
# 0: if the user SAGE_ATLAS_LIB worked
# 1: if SAGE_ATLAS_LIB wass not set
# 2: if SAGE_ATLAS_LIB is set but does not contain the correct libraries

if [ $output = 0 ]; then
  exit 0
fi

if [ $output = 2 ]; then
  exit 1
fi

config()
{
        mkdir ATLAS-build
	cd ATLAS-build
	# -Si cputhrchk 0: Ignore/heed CPU throttle probe
	# -Fa alg -fPIC: set flags so we can build dynamic libraries
	# -t 0: disable threading for now.
	../src/ATLAS/configure --prefix="$SAGE_LOCAL" --with-netlib-lapack="$SAGE_LOCAL"/lib/liblapack.a  \
	-Si cputhrchk 0 -Fa alg -fPIC -t 0 -C if $FCOMPILER -b $bitwidth
}


build()
{
	# build library
	cd $CUR/ATLAS-build
	make

        # we need to disable parallel builds for the libraries and install
        MAKE=make
	# now build the shared libraries
	cd lib
	make shared cshared

	# and now install
	cd ..
	make install
}

if [ `uname` = "Darwin" ]; then
    exit 0
fi


CUR=`pwd`
echo $CUR
echo Updating archinfo_linux.c
cp patches/archinfo_linux.c src/ATLAS/CONFIG/src/backend/
echo Updating atlconf.h
cp patches/atlconf.h  src/ATLAS/CONFIG/include/
echo Updating atlcomp.txt
cp patches/atlcomp.txt src/ATLAS/CONFIG/src/
echo Updating Make.top
cp patches/Make.top src/ATLAS/

config

build

cd $CUR/ATLAS-build
if [ -f error* ]; then
    echo "ATLAS failed to build because your system is too heavily loaded to obtain accurate timing."
    echo "Please restart the build by typing make, when the load on your system has decreased."
    exit 1
fi

cd $CUR
sh ./make_correct_shared.sh

