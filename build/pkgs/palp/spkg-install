#!/bin/sh

# Move over the GNU makefile to the file 'Makefile'.
# If SAGE64 is set to yes, add an '-m64' using 'sed'

if [ "x$SAGE64" = xyes ] ; then
  echo "Creating a 64-bit version of PALP"
  sed 's/^CFLAGS=/CFLAGS=-m64 /g' src/GNUmakefile > src/Makefile
  if [ $? -ne 0 ]; then
      echo "Error patching PALP."
      exit 1
  fi
  # We must delete src/GNUmakefile, otherwise that gets used in preference to Makefile.
  rm src/GNUmakefile
else
  mv -f src/GNUmakefile src/Makefile
fi

# Remove some dead code that uses a GNU C extension that breaks on OSX
# see http://trac.sagemath.org/sage_trac/ticket/12055#comment:31
cp -p patches/Polynf.c src/Polynf.c

cd src
mv Global.h Global.h-template

for dim in 4 5 6 11; do
    echo Building PALP optimized for $dim dimensions

    sed "s/^#define\s*POLY_Dmax.*/#define POLY_Dmax $dim/" Global.h-template > Global.h

    $MAKE
    if [ $? -ne 0 ]; then
	echo "Error building PALP."
	exit 1
    fi

    for file in poly class cws nef mori; do
	cp -p ${file}.x "$SAGE_LOCAL"/bin/${file}-${dim}d.x
	if [ $? -ne 0 ]; then
	    echo "Error installing PALP."
	    exit 1
	fi
    done

    # the next step is important to avert races on older file systems
    # for example, ext3 has 1-second timestamp granularity!
    $MAKE cleanall
    if [ $? -ne 0 ]; then
	echo "Error building PALP."
	exit 1
    fi
done

# symlinks for the default dimension
cd "$SAGE_LOCAL"/bin
for file in poly class cws nef mori; do
    ln -sf ${file}-6d.x ${file}.x
done

